name: Tests

on:
    pull_request:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  PRIVATE_REPO_ACCESS_TOKEN: ${{ secrets.ACTIONS_PRIVATE_REPO_RO_TOKEN }}
  STATA_LICENSE: ${{ secrets.STATA_LICENSE }}

jobs:
  test-package-build:
    runs-on: ubuntu-latest
    name: Test we can build PyPI package
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
          cache: "pip"
          cache-dependency-path: requirements.*.txt

      # We need to set this to a valid version string in order to keep pip happy,
      # but it doesn't really matter what version we use
      - name: Set version
        run: echo '1.0' > VERSION
      - name: Build package
        run: |
          pip install pip==22.0.4
          pip install build wheel
          python -m build
      - name: Check that wheel installs and runs
        run: |
          python -m venv test-wheel
          test-wheel/bin/pip install dist/*.whl
          # Minimal check that it has actually built correctly
          test-wheel/bin/add_job --help
      - name: Check that sdist installs and runs
        run: |
          python -m venv test-sdist
          test-sdist/bin/pip install dist/*.tar.gz
          # Minimal check that it has actually built correctly
          test-sdist/bin/add_job --help
