openapi: 3.1.0

info:
  title: RAP API
  description: OpenSAFELY Reproducible Analytic Pipeline (RAP) API
  version: "v1"

servers:
- url: /controller/v1/

paths:
  /backend/status/:
    get:
      security:
        - bearerAuth: []
      description: |
        Get the status (flags) for all backends.
      tags:
        - backends
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                type: object
                required:
                  - backends
                properties:
                  backends:
                    type: array
                    items:
                      type: object
                      required:
                        - slug
                        - last_seen
                        - paused
                        - db_maintenance
                      properties:
                        slug:
                         type: string
                         description: Slug of backend
                        last_seen:
                          description: Time of last contact from this backend
                          $ref: "#/components/schemas/timestamp"
                          nullable: true
                        paused:
                          description: Backend paused status (determines whether backend accepts new jobs)
                          type: object
                          required:
                            - status
                            - since
                          properties:
                            status:
                              $ref: "#/components/schemas/backendFlagStatus"
                            since:
                              description: Time backend was last paused/unpaused
                              $ref: "#/components/schemas/timestamp"
                              nullable: true
                        db_maintenance:
                          description: Is this backend in database maintenance mode?
                          type: object
                          required:
                            - status
                            - since
                            - type
                          properties:
                            status:
                              $ref: "#/components/schemas/backendFlagStatus"
                            since:
                              description: Time maintenance mode was last updated for this backend
                              $ref: "#/components/schemas/timestamp"
                              nullable: true
                            type:
                              type: string
                              enum:
                                - scheduled
                                - manual
                              nullable: true
              examples:
                normal_operation:
                  description: Backend 'test' operating normally
                  value:
                    backends:
                      - slug: test
                        last_seen: 2025-08-12T11:30:45.123456Z
                        paused:
                          status: off
                          since: 2025-08-12T11:30:45.123456Z
                        db_maintenance:
                          status: off
                          since: null
                          type: null
                paused:
                  description: Backend 'test' paused
                  value:
                    backends:
                      - slug: test
                        last_seen:
                          since: 2025-08-12T11:30:45.123456Z
                        paused:
                          status: on
                          since: 2025-08-12T11:30:45.123456Z
                        db_maintenance:
                          status: off
                          since: null
                          type: null
                scheduled_db_maintenance:
                  description: Backend 'test' in scheduled db maintenance
                  value:
                    backends:
                      - slug: test
                        last_seen: 2025-08-12T11:30:45.123456Z
                        paused:
                          status: off
                          since: 2025-08-12T11:30:45.123456Z
                        db_maintenance:
                          status: on
                          since: 2025-08-12T11:30:45.123456Z
                          type: scheduled
                manual_db_maintenance:
                  description: Backend 'test' in manual db maintenance
                  value:
                    backends:
                      - slug: test
                        last_seen: 2025-08-12T11:30:45.123456Z
                        paused:
                          status: off
                          since: 2025-08-12T11:30:45.123456Z
                        db_maintenance:
                          status: on
                          since: 2025-08-12T11:30:45.123456Z
                          type: manual
        401:
          $ref: "#/components/responses/401Unauthorized"

  /rap/create/:
      post:
        security:
          - bearerAuth: []
        description: |
          Create a RAP with one or more actions
        tags:
        - rap_operations
        requestBody:
          required: true
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/createRequestBody"
              examples:
                example1:
                  value:
                    backend: test
                    rap_id: abcdefgh23456789
                    workspace: test-study
                    repo_url: https://github.com/opensafely/test-study
                    branch: main
                    commit: 07d5f283bb66f52a49933b016cf8dc144cfc7180
                    database_name: default
                    requested_actions:
                     - action1
                    codelists_ok: true
                    force_run_dependencies: false
                    created_by: test_user
                    project: test-project
                    orgs:
                     - opensafely
                    analysis_scope:
                example2:
                  value:
                    backend: test
                    rap_id: abcdefgh87654321
                    workspace: my-study-workspace
                    repo_url: https://github.com/opensafely/a-new-study
                    branch: v1
                    commit: d090466f63b0d68084144d8f105f0d6e79a0819e
                    database_name: default
                    requested_actions:
                     - generate_dataset
                    codelists_ok: true
                    force_run_dependencies: false
                    created_by: user1
                    project: my-project
                    orgs:
                     - opensafely
                    analysis_scope:
                      dataset_permissions:
                        - appointments
                      population_permissions:
                        - include_t1oo
                        - include_ndoo
                      component_access:
                        - event_level_data
        responses:
          201:
            description: OK; jobs created
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    result:
                      type: string
                    details:
                      type: string
                    rap_id:
                      type: string
                    count:
                      type: number
                examples:
                  success:
                    description: success
                    value:
                      result: Success
                      details: Jobs created for rap_id 'a1b2c3d4e5f6g7h8'
                      rap_id: a1b2c3d4e5f6g7h8
                      count: 1
          200:
            description: OK, jobs already created
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    result:
                      type: string
                    details:
                      type: string
                    rap_id:
                      type: string
                    count:
                      type: number
                examples:
                  no_change:
                    description: Jobs already created
                    value:
                      result: No change
                      details: Jobs already created for rap_id 'a1b2c3d4e5f6g7h8'
                      rap_id: a1b2c3d4e5f6g7h8
                      count: 1
                  already_succeeded:
                    description: Jobs running these actions already completed successfully; no new jobs were created
                    value:
                      result: Nothing to do
                      details: All actions have already completed successfully
                      rap_id: a1b2c3d4e5f6g7h8
                      count: 0
                  already_scheduled:
                    description: Jobs to run these actions are already completed or scheduled; no new jobs were created
                    value:
                      result: Nothing to do
                      details: All requested actions were already scheduled to run
                      rap_id: a1b2c3d4e5f6g7h8
                      count: 0
          400:
            description: Bad request
            content:
              application/json:
                schema:
                  type: object
                  required:
                   - error
                   - details
                  properties:
                    error:
                      type: string
                    details:
                      type: string
                examples:
                  validation_error:
                    description: Missing rap_id
                    value:
                      error: Validation error
                      details: "Invalid request body received: 'rap_id' is a required property"
                  git_error:
                    description: Error creating jobs - git error
                    value:
                      error: Error creating jobs
                      details: "GitError: Error fetching commit d090466f63b0d68084144d8f105f0d6e79a0819e from https://github.com/opensafely/a-new-study"
                  duplicate_rap_error:
                    description: Jobs already exist for this RAP ID that are inconsistent with the data provided in this request
                    value:
                      error: Inconsistent request data
                      details: "Jobs already created for rap_id 'abcdegh12345678' are inconsistent with request data"
                  unknown_error:
                    description: Unexpected error creating jobs
                    value:
                      error: Error creating jobs
                      details: Unknown error
          401:
            $ref: "#/components/responses/401Unauthorized"

  /rap/cancel/:
      post:
        security:
          - bearerAuth: []
        description: |
          Cancel one or more actions.
        tags:
        - rap_operations
        requestBody:
          required: true
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/cancelRequestBody"
              examples:
                example1:
                  value:
                    rap_id: a1b2c3d4e5f6g7h8
                    actions: ["action1"]
                example2:
                  value:
                    rap_id: abcdefgh12345678
                    actions: ["action2", "action3"]
        responses:
          200:
            description: OK
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    result:
                      type: string
                    details:
                      type: string
                    count:
                      description: Number of actions cancelled
                      type: integer
                examples:
                  success:
                    description: 2 actions successfully cancelled
                    value:
                      result: Success
                      details: 2 actions cancelled
                      count: 2
          400:
            description: Bad request
            content:
              application/json:
                schema:
                  type: object
                  required:
                   - error
                   - details
                  properties:
                    error:
                      type: string
                    details:
                      type: string
                examples:
                  validation_error:
                    description: Missing rap_id
                    value:
                      error: Validation error
                      details: "Invalid request body received: 'rap_id' is a required property"
          401:
            $ref: "#/components/responses/401Unauthorized"
          404:
            description: No matching jobs for RAP id
            content:
              application/json:
                schema:
                  type: object
                  required:
                   - error
                   - details
                  properties:
                    error:
                      type: string
                    details:
                      type: string
                    rap_id:
                      description: rap_id parameter
                      type: string
                    not_found:
                      description: actions requested for cancellation that do not exist for the requested rap_id
                      type: array
                      items:
                        type: string
                examples:
                  data_error1:
                    description: No jobs found matching rap_id
                    value:
                      error: jobs not found
                      details: No jobs found for rap_id abcdefgh12345678
                      rap_id: abcdefgh12345678
                  data_error2:
                    description: Jobs matching requested cancel actions are not found
                    value:
                      error: Jobs not found
                      details: "Jobs matching requested cancelled actions could not be found: action1,action2"
                      rap_id: abcdefgh12345678
                      not_found: ["action1", "action2"]
  /rap/status/:
      post:
        security:
          - bearerAuth: []
        description: |
          Get the status of RAPs
        tags:
        - rap_operations
        requestBody:
          required: true
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/statusRequestBody"
              examples:
                example1:
                  value:
                    rap_ids: [
                      a1b2c3d4e5f6g7h8
                    ]
                example2:
                  value:
                    rap_ids: [
                      abcdefgh12345678
                    ]
        responses:
          200:
            description: OK
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    jobs:
                      type: array
                      items:
                        $ref: "#/components/schemas/job"
                    unrecognised_rap_ids:
                      type: array
                      items:
                        type: string
                        pattern: '^[a-z0-9]{16}$'
                examples:
                  success:
                    description: success
                    value:
                      jobs:
                        [
                          {
                            'action': 'action1',
                            'backend': 'test',
                            'completed_at': None,
                            'created_at': '2025-08-28T09:27:26.123456Z',
                            'identifier': 'zhgksvaob3u5opzv',
                            'metrics': {
                              'test': 0.0,
                            },
                            'rap_id': 'tqyly5nljliltsxj',
                            'requires_db': False,
                            'run_command': 'python myscript.py',
                            'started_at': None,
                            'status': 'failed',
                            'status_code': 'created',
                            'status_message': '',
                            'trace_context': {
                              'traceparent': '00-ee668ef06f2f1564c028eea1d9be716d-5b3ca103cdd2a017-01',
                            },
                            'updated_at': '2025-08-28T09:27:26.123456Z',
                          }
                        ]
                      unrecognised_rap_ids:
                        []
                  unrecognised_rap_ids:
                    description: No jobs corresponding to rap_id
                    value:
                      jobs:
                        []
                      unrecognised_rap_ids:
                        ['abcdefg12345678']
          400:
            description: Bad response
            content:
              application/json:
                schema:
                  type: object
                  required:
                   - error
                   - details
                  properties:
                    error:
                      type: string
                    details:
                      type: string
                examples:
                  validation_error:
                    description: Missing rap_ids
                    value:
                      error: Validation error
                      details: "Invalid request body received: 'rap_ids' is a required property"
          401:
            $ref: "#/components/responses/401Unauthorized"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: token
  schemas:
    createRequestBody:
      # Can be referenced as '#/components/schemas/createRequestBody'
      type: object
      required:
        - backend
        - rap_id
        - workspace
        - repo_url
        - branch
        - commit
        - database_name
        - requested_actions
        - codelists_ok
        - force_run_dependencies
        - created_by
        - project
        - orgs
      properties:
        backend:
          description: The backend this RAP should run on
          type: string
        rap_id:
          description: A unique identifier for this RAP
          type: string
          pattern: '^[a-z0-9]{16}$'
        workspace:
          type: string
          pattern: '[a-zA-Z0-9_-]+'
        repo_url:
          type: string
        branch:
          type: string
        commit:
          description: commit sha
          type: string
          pattern: '^[0-9a-f]{40}$'
        database_name:
          type: string
          enum:
            - default
            - include_t1oo
        requested_actions:
          description: |
            The explicitly requested actions to run as part of this RAP.
            Note that other actions may be run if they are unmet dependencies of the
            requested actions.
          type: array
          minItems: 1
          items:
            type: string
        codelists_ok:
          type: boolean
        force_run_dependencies:
          type: boolean
        created_by:
          description: Username
          type: string
        project:
          type: string
        orgs:
          type: array
          items:
            type: string
        analysis_scope:
          description: Permissions and configuration to be applied to the execution of actions in this RAP.
          type: object
          nullable: true
          properties:
            dataset_permissions:
              description: A list of restricted datasets that this RAP has permission to use.
              type: array
              items:
                type: string
                enum:
                  - appointments
                  - icnarc
                  - isaric
                  - open_prompt
                  - ukrr
                  - waiting_list
            population_permissions:
              description: A list of population filters that this RAP is allowed to access.
              type: array
              items:
                type: string
                enum:
                  - include_ndoo
                  - include_t1oo
                  - include_gp_unactivated
            component_access:
              description: A list of analysis components that this RAP is allowed or required to apply.
              type: array
              items:
                type: string
                enum:
                  - event_level_data
                  - patient_id_detection

    backendFlagStatus:
      # Can be referenced as '#/components/schemas/backendFlagStatus'
      type: string
      enum:
        - "on"
        - "off"
    cancelRequestBody:
      # Can be referenced as '#/components/schemas/cancelRequestBody'
      type: object
      required:
        - rap_id
        - actions
      properties:
        rap_id:
          type: string
          pattern: '^[a-z0-9]{16}$'
        actions:
          type: array
          minItems: 1
          items:
            type: string
    timestamp:
      # Can be referenced as '#/components/schemas/timestamp'
      type: string
      pattern: '^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:.\d{6})?Z$'
      description: Isoformat timestamp
    statusRequestBody:
      # Can be referenced as '#/components/schemas/statusRequestBody'
      type: object
      required:
        - rap_ids
      properties:
        rap_ids:
          type: array
          items:
            type: string
            pattern: '^[a-z0-9]{16}$'
    job:
      # Can be referenced as '#/components/schemas/job'
      type: object
      required:
        - identifier
      properties:
        action:
          type: string
        backend:
          type: string
        completed_at:
          $ref: "#/components/schemas/timestamp"
          nullable: true
        created_at:
          $ref: "#/components/schemas/timestamp"
        identifier:
          type: string
        metrics:
          type: object
        rap_id:
          type: string
          pattern: '^[a-z0-9]{16}$'
        requires_db:
          type: boolean
        run_command:
          type: string
        started_at:
          $ref: "#/components/schemas/timestamp"
          nullable: true
        status:
          type: string
          enum:
            - pending
            - running
            - succeeded
            - failed
        status_code:
          type: string
          enum:
            - created
            - initiated
            - paused
            - waiting_db_maintenance
            - waiting_on_dependencies
            - waiting_on_workers
            - waiting_on_db_workers
            - waiting_on_reboot
            - waiting_on_new_task
            - preparing
            - prepared
            - executing
            - executed
            - finalizing
            - finalized
            - succeeded
            - dependency_failed
            - nonzero_exit
            - cancelled_by_user
            - unmatched_patterns
            - internal_error
            - killed_by_admin
            - stale_codelists
            - job_error
        status_message:
          type: string
        trace_context:
          type: object
        updated_at:
          $ref: "#/components/schemas/timestamp"
          nullable: true
  responses:
    401Unauthorized:
      # Can be referenced as '#/components/responses/401Unauthorized'
      description: Unauthorized
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              details:
                type: string
          examples:
            invalid_token:
              value:
                error: "Unauthorized"
                details: "Invalid token"

security:
  - bearerAuth: []

tags:
  - name: backends
    x-displayName: Backend status
    description: Endpoints that provide information about backend status.
  - name: rap_operations
    x-displayName: RAP Operations
    description: Endpoints that perform operations on RAPs
